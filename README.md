### Multi Social API with Devise, OmniAuth for Facebook, Twitter, Linkedin 
- Objective to have single user identity linked to multiple OAuth identities 
- Even if multiple OAuth identities have different emails associated with each social platform
- Twitter doesn't share user's email, so we need to get from user
- Ability to have User deselect or select multiple social logins from within their profile 
- and activate them all so, they can login with any of their profiles
- If user doesn't want to use a social login they can create a user account using devise 

#### Base application generated by my template.rb (github.com/KudosX/template.rb):
- Gemset ruby-2.3.0@rails5.0.0.beta3
- Ruby 2.3.0
- Rails 5.0.0.beta3

#### MVC Overview:
- will split models into User and Identity, Identity is for multiple OAuth identities
- will use controllers; application, omniauth_callbacks, sessions
- will use devise and custom views

#### Gems for this project (pinterest, instagram for future addition)
```
gem 'devise'
gem 'therubyracer'
gem 'omniauth-facebook'
gem 'omniauth-twitter'
gem 'omniauth-linkedin'
gem 'omniauth-pinterest'
gem 'omniauth-instagram'
```
* if you have problems making therubyracer gem work in mac try this:
```
brew install v8-315
bundle config --local build.libv8 --with-system-v8
bundle config --local build.therubyracer --with-v8-dir=/usr/local/opt/v8-315
bundle install
```
#### References for this project for login
- https://github.com/plataformatec/devise/wiki/OmniAuth%3A-Overview
- https://github.com/plataformatec/devise/wiki/OmniAuth-with-multiple-models
- https://github.com/intridea/omniauth/wiki/Managing-Multiple-Providers
- https://github.com/intridea/omniauth/wiki/List-of-Strategies
- https://github.com/arunagw/omniauth-twitter
- https://github.com/skorks/omniauth-linkedin
- https://github.com/mkdynamic/omniauth-facebook
- https://github.com/jot/omniauth-pinterest/
- http://www.sitepoint.com/series/authentication-in-rails/
- http://sourcey.com/rails-4-omniauth-using-devise-with-twitter-facebook-and-linkedin/

#### References to tweet as the authenticated user and post with facebook (not implemented):
- https://github.com/sferik/twitter
- https://richonrails.com/articles/sending-a-tweet-to-twitter
- https://launchschool.com/blog/facebook-graph-api-using-omniauth-facebook-and-koala
- http://snippets.aktagon.com/snippets/512-how-to-post-a-message-to-the-facebook-wall-with-omniauth-devise
- http://revelry.co/a-beginners-guide-to-using-the-facebook-api-in-your-rails-application-part-1/

#### Step 1: setup devise
- `rails g devise:install` devise outputs some manual steps, be sure to do steps 1, 3, 5 manually, 
- `rails g devise User` creates User model
- Note: if your server is running be sure to stop the server before running rake command
- `rake db:migrate` to create database

#### Step 2: copy all devise views into application
- `rails g devise:views` creates views/devise

#### Step 3: add action to not serve up pages until user authenticated:
add `before_action :authenticate_user!, :except => [:index, :about, :contact, :faq]` 
to application_controller just before `end`

#### Step 4: to view routes
`rake routes` to see list of existing routes
- localhost:3000/users/sign_in
- localhost:3000/users/sign_up

#### Step 5: create additional models and controllers
- create identity model
- `rails g model identity provider:string uid:string user_id:integer`
- create a sessions controller for actions `rails g controller sessions`
- create a omniauth_callbacks controller `rails g controller omniauth_callbacks`
- run `rake db:migrate`

#### Step 6: get client ID(KEY) and SECRET from OAuth providers, we will do twitter first
- https://dev.twitter.com/oauth/overview/application-owner-access-tokens
- https://apps.twitter.com to create your application
- Twitter: http://127.0.0.1:3000/users/auth/twitter/callback , can't use "localhost" in callback
- after we are done with application we will go back and do the others so, not to conflate our problems

#### Step 7: add ENVIRONMENT VARIABLES to .bash_profile on mac 
- for development mode only
- `nano .bash_profile` will open your bash file
- replace between " " with credentials received from twitter
- NOTE: close terminal to reset .bash_profile when done
```
export TWITTER_KEY="xxxxxkey_from_twitter_apixxxxxx"
export TWITTER_SECRET="xxxxxxsecret_from_twitter_apixxxxxx"
```

#### Step 8: add OmniAuth configuration, ENVIRONMENT VARIABLES to omniauth.rb
- create config/omniauth.rb file and add the following
```
Rails.application.config.middleware.use OmniAuth::Builder do
  provider :twitter, ENV['TWITTER_KEY'], ENV['TWITTER_SECRET'],
  provider :facebook, ENV['FACEBOOK_ID'], ENV['FACEBOOK_SECRET'],
  provider :linkedin, ENV['CONSUMER_KEY'], ENV['CONSUMER_SECRET']
end 
```
- setup omniauth's "on_failure" hook outside OmniAuth configuration block
- add the following code in same file just below block in omniauth.rb
- `OmniAuth.config.on_failure = Proc.new { |env| SessionsController.action(:failure).call(env) }`       
             
#### Step 9: add some convenience methods for creating identities and users for callback
- add to models/user.rb
```
class User < ApplicationRecord
  has_many :identities
  def self.create_with_omniauth(info)
    create(name: info['name'])
  end
end
```
- add to models/identity.rb
```
class Identity < ApplicationRecord
  belongs_to :user
  validates_presence_of :uid, :provider
  validates_uniqueness_of :uid, :scope => :provider
  def self.find_with_omniauth(auth)
    find_by(uid: auth['uid'], provider: auth['provider'])
  end
  def self.create_with_omniauth(auth)
    create(uid: auth['uid'], provider: auth['provider'])
  end
end
```

#### Step 10: handle logging in and logging out
- setup a callback in routes.rb
```
devise_for :users, :controllers => { :omniauth_callbacks => 'omniauth_callbacks' }
match '/auth/:provider/callback', to: 'sessions#create', via: [:get, :post]
match '/logout', to: 'sessions#destroy', via: [:get, :post]
```



